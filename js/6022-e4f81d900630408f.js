"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6022],{66106:function(e,o,t){t.r(o),t.d(o,{ChatLayoutProvider:function(){return i},useChatLayout:function(){return l}});var s=t(9579),n=t(82933),a=t(37102);let r=n.createContext({open:!0,setOpen:()=>{},sheetOpen:!1,setSheetOpen:()=>{},chatDialogOpen:!1,setChatDialogOpen:()=>{},activeWorkflowId:"",setActiveWorkflowId:()=>{},input:"",setInput:()=>{},hasSentInitialQuery:"false",setHasSentInitialQuery:()=>{},files:[],setFiles:()=>{},isNewChat:!1,setIsNewChat:()=>{},sidebarChats:[],setSidebarChats:()=>{},headerChat:{id:"",name:"",workflow:[]},setHeaderChat:()=>{},onboardingStep:null,setOnboardingStep:()=>{}});function l(){let e=n.useContext(r);if(!e)throw Error("useChatLayout must be used within a ChatLayoutProvider");return e}let i=e=>{let{children:o}=e,[t,l]=n.useState(!0),[i,d]=n.useState(!1),[u,c]=n.useState(!1),[w,f]=n.useState(""),[g,m]=(0,a.X)("input",""),[k,p]=(0,a.X)("hasSentInitialQuery","false"),[v,h]=n.useState([]),[y,x]=n.useState(!1),[C,I]=n.useState([]),[S,M]=n.useState({id:"",name:"",workflow:[]}),[b,Q]=n.useState(null),O=n.useMemo(()=>({open:t,setOpen:l,sheetOpen:i,setSheetOpen:d,chatDialogOpen:u,setChatDialogOpen:c,activeWorkflowId:w,setActiveWorkflowId:f,input:g,setInput:m,hasSentInitialQuery:k,setHasSentInitialQuery:p,files:v,setFiles:h,isNewChat:y,setIsNewChat:x,sidebarChats:C,setSidebarChats:I,headerChat:S,setHeaderChat:M,onboardingStep:b,setOnboardingStep:Q}),[t,i,u,w,g,m,k,p,v,y,C,S,b,Q]);return(0,s.jsx)(r.Provider,{value:O,children:o})}},59920:function(e,o,t){t.r(o),t.d(o,{ChatStoreProvider:function(){return g},useChatStore:function(){return m}});var s=t(9579),n=t(82933),a=t(15780),r=e=>({messages:[],addMessage:function(o){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",s=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e(e=>{let n="".concat(t,"-currentMessage"),a=e.messages.findIndex(e=>e.id===o.id);if(a>=0&&s){let t=[...e.messages];return t[a]={...t[a],content:t[a].content+o.content},sessionStorage.setItem(n,JSON.stringify(t[a])),{messages:t}}{let s=JSON.parse(sessionStorage.getItem(n)||"{}");s.id&&o.id!==s.id&&(sessionStorage.removeItem(n),s={});let a={...o,content:s.content?s.content+o.content:o.content},r=[...e.messages,a];return""!==t&&sessionStorage.setItem(n,JSON.stringify(a)),{messages:r}}})},updateMessage:(o,t)=>e(e=>({messages:e.messages.map(e=>e.id===o&&"assistant"===e.role?{...e,...t}:e)})),addToolMessage:o=>e(e=>({messages:[...e.messages,o]})),updateToolMessage:(o,t)=>e(e=>({messages:e.messages.map(e=>{if(e.id===o&&"tool"===e.role){let o=t.tool.actions?[...e.tool.actions||[],...t.tool.actions]:e.tool.actions,s={...e.tool,...t.tool,actions:o};return{...e,tool:s}}return e})})),updateChatWorkflow:(o,t)=>e(e=>{let s=e.messages.find(e=>{var t;return(null===(t=e.workflow)||void 0===t?void 0:t.id)===o});if(!s||!s.workflow)return e;{let n={...s.workflow,...t};return{messages:e.messages.map(e=>{var t;return(null===(t=e.workflow)||void 0===t?void 0:t.id)===o?{...e,workflow:n}:e})}}}),addToolMessageToChatWorkflow:(o,t)=>e(e=>{let s=e.messages.find(e=>{var t;return(null===(t=e.workflow)||void 0===t?void 0:t.id)===o});if(!s||!s.workflow)return e;{let n=[...s.workflow.messages,t],a={...s.workflow,messages:n};return{messages:e.messages.map(e=>{var t;return(null===(t=e.workflow)||void 0===t?void 0:t.id)===o?{...e,workflow:a}:e})}}}),updateToolMessageInChatWorkflow:(o,t)=>e(e=>{let s=e.messages.find(e=>{var t;return(null===(t=e.workflow)||void 0===t?void 0:t.id)===o});if(!s||!s.workflow)return e;{let n=(0,a.E4)(s.workflow.messages).map(e=>{if(e.id===t.id&&e.tool){let o={...e.tool,...t.tool,actions:t.tool.actions?[...e.tool.actions||[],...t.tool.actions]:e.tool.actions};return{...e,tool:o}}return e}),r={...s.workflow,messages:n};return{messages:e.messages.map(e=>{var t;return(null===(t=e.workflow)||void 0===t?void 0:t.id)===o?{...e,workflow:r}:e})}}}),setMessages:o=>e(()=>({messages:o}))}),l=e=>({isProcessingMessage:!1,setProcessingMessage:o=>e(()=>({isProcessingMessage:o}))}),i=e=>({workflows:[],addWorkflow:o=>e(e=>({workflows:[o,...e.workflows]})),updateWorkflow:(o,t)=>e(e=>({workflows:e.workflows.map(e=>e.id===o?{...e,...t}:e)})),addMessageToWorkflow:(o,t)=>e(e=>({workflows:e.workflows.map(e=>e.id===o?{...e,messages:[...e.messages,t]}:e)})),updateToolMessageInWorkflow:(o,t)=>e(e=>({workflows:e.workflows.map(e=>e.id===o?{...e,messages:(0,a.E4)(e.messages).map(e=>{if(e.id===t.id){let o=t.tool.actions?[...e.tool.actions||[],...t.tool.actions]:e.tool.actions,s={...e.tool,...t.tool,actions:o};return{...e,content:t.content||e.content,tool:s}}return e})}:e)})),setWorkflows:o=>e(()=>({workflows:o}))}),d=t(55748);let u=()=>(0,d.Ue)(function(){for(var e=arguments.length,o=Array(e),t=0;t<e;t++)o[t]=arguments[t];return{...i(...o),...r(...o),...l(...o)}}),c=new Map,w=e=>(c.has(e)||c.set(e,u()),c.get(e)),f=(0,n.createContext)(null),g=n.memo(function(e){let{children:o,chatId:t}=e,n=w(t);return(0,s.jsx)(f.Provider,{value:{store:n},children:o})}),m=()=>{let e=(0,n.useContext)(f);if(null===e)throw Error("useChatStore must be used within a ChatStoreProvider");return e}},36022:function(e,o,t){t.r(o),t.d(o,{WebSocketContext:function(){return Q},WebSocketProvider:function(){return O}});var s=t(9579),n=t(82933),a=t(86505);class r{createSocket(e,o,t){return this.sockets[e]||(this.sockets[e]=new a.Z({host:"realtime.cognosys.ai",room:e,query:async()=>({token:await o({template:"clerk-email"})}),connectionTimeout:2e3,maxRetries:5}),this.sockets[e].onopen=t.onOpen,this.sockets[e].onerror=t.onError,this.sockets[e].onclose=t.onClose,this.sockets[e].onmessage=t.onMessage),this.sockets[e]}closeSocket(e){this.sockets[e]&&(this.sockets[e].close(),delete this.sockets[e])}constructor(){this.sockets={}}}let l=new r;var i=t(26580);class d{addCallback(e,o){this.callbacks[e]=o}executeCallback(e,o,t){let s=this.callbacks[e];s&&(s(o,t),delete this.callbacks[e])}constructor(){this.callbacks={}}}let u=new d;var c=t(8964),w=t(11859);let f=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return function(t){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n="".concat(e,"-currentMessage");o.setQueryData(["messages",{chatId:e}],o=>{let a,r,l;let{messages:i=[],indexMap:d={},workflowMap:u={}}=o;if(void 0!==d[t.id]&&s){a=[...i],r={...d},l={...u};let e=d[t.id].index;a[e]={...a[e],content:a[e].content+t.content}}else{let o=JSON.parse(sessionStorage.getItem(n)||"{}");o.id&&t.id!==o.id&&(sessionStorage.removeItem(n),o={});let s={...t,content:o.content?o.content+t.content:t.content};a=[...i,s],r={...d,[s.id]:{index:i.length}},l={...u},s.workflow&&(l[s.workflow.id]={index:i.length,parentMessageId:s.id},s.workflow.messages.forEach((e,o)=>{r[e.id]={index:o,parentMessageId:s.id}})),e&&sessionStorage.setItem(n,JSON.stringify(s))}return{messages:a,indexMap:r,workflowMap:l}})}},g=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return(t,s)=>{o.setQueryData(["messages",{chatId:e}],function(){var e;let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{messages:[],indexMap:{},workflowMap:{}},{messages:n,indexMap:a}=o,r=null===(e=a[t])||void 0===e?void 0:e.index;if("number"==typeof r){let e=[...n];return e[r]={...n[r],...s},{...o,messages:e}}return o})}},m=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return t=>{o.setQueryData(["messages",{chatId:e}],function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{messages:[],indexMap:{},workflowMap:{}},o=[...e.messages,t],s={...e.indexMap,[t.id]:{index:e.messages.length}};return{...e,messages:o,indexMap:s}})}},k=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return(t,s)=>{o.setQueryData(["messages",{chatId:e}],function(){var e;let o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{messages:[],indexMap:{},workflowMap:{}},{messages:n,indexMap:a}=o,r=null===(e=a[t])||void 0===e?void 0:e.index;if("number"==typeof r){let e=[...n],t=n[r],a={...t,tool:{...t.tool,...s.tool,actions:s.tool.actions?[...t.tool.actions||[],...s.tool.actions]:t.tool.actions}};return e[r]=a,{...o,messages:e}}return o})}},p=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return(t,s)=>{o.setQueryData(["messages",{chatId:e}],e=>{let{messages:o=[],indexMap:n={},workflowMap:a={}}=e,r=a[t];if(r){var l;let{index:e}=r;if(o[e]&&o[e].workflow&&(null===(l=o[e].workflow)||void 0===l?void 0:l.id)===t){let t=[...o],r=t[e],l={...r.workflow,...s};return l.messages.forEach((o,t)=>{n[o.id]||(n[o.id]={index:e,parentMessageId:r.id,workflowIndex:t})}),t[e]={...r,workflow:l},{messages:t,indexMap:n,workflowMap:a}}}return e})}},v=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return(t,s)=>{o.setQueryData(["messages",{chatId:e}],e=>{var o;if(!e)return{messages:[],indexMap:{},workflowMap:{}};let{messages:n,indexMap:a,workflowMap:r}=e,l=r[t];if(!l)return e;let i=[...n],d=l.index,u={...i[d]};if(!u||(null===(o=u.workflow)||void 0===o?void 0:o.id)!==t)return e;let c={...u.workflow},w=c.messages?[...c.messages,s]:[s];return c.messages=w,i[d]={...u,workflow:c},{messages:i,indexMap:{...a,[s.id]:{index:d,parentMessageId:u.id,workflowIndex:w.length-1}},workflowMap:r}})}},h=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return(t,s)=>{o.setQueryData(["messages",{chatId:e}],e=>{var o,n,a,r,l;let i;if(!e||!e.indexMap)return e;let d=e.indexMap[s.id];if(!d||void 0===d.workflowIndex)return e;let u=d.index,c=e.messages[u];if(!c||(null===(o=c.workflow)||void 0===o?void 0:o.id)!==t)return e;if(s.tool.actions&&"streaming"===s.tool.actions[0].actionType){let e=s.tool.actions[0];i=(null===(n=c.workflow.messages[d.workflowIndex].tool.actions)||void 0===n?void 0:n.find(o=>o.id===e.id))?{...c.workflow.messages[d.workflowIndex],tool:{...c.workflow.messages[d.workflowIndex].tool,actions:null===(a=c.workflow.messages[d.workflowIndex].tool.actions)||void 0===a?void 0:a.map(o=>o.id===e.id?{...o,ui:{...o.ui,content:{...o.ui.content,text:o.ui.content.text+e.ui.content.text}}}:o)}}:{...c.workflow.messages[d.workflowIndex],tool:{...c.workflow.messages[d.workflowIndex].tool,...s.tool,actions:[...c.workflow.messages[d.workflowIndex].tool.actions||[],...s.tool.actions]}}}else i=s.tool.actions&&"end"===s.tool.actions[0].actionType?{...c.workflow.messages[d.workflowIndex],tool:{...c.workflow.messages[d.workflowIndex].tool,...s.tool,actions:s.tool.actions?[...(null===(r=c.workflow.messages[d.workflowIndex].tool.actions)||void 0===r?void 0:r.filter(e=>"streaming"!==e.actionType))||[],...s.tool.actions]:null===(l=c.workflow.messages[d.workflowIndex].tool.actions)||void 0===l?void 0:l.filter(e=>"streaming"!==e.actionType)}}:{...c.workflow.messages[d.workflowIndex],tool:{...c.workflow.messages[d.workflowIndex].tool,...s.tool,actions:s.tool.actions?[...c.workflow.messages[d.workflowIndex].tool.actions||[],...s.tool.actions]:c.workflow.messages[d.workflowIndex].tool.actions}};let w=[...e.messages],f=[...c.workflow.messages];return f[d.workflowIndex]=i,w[u]={...c,workflow:{...c.workflow,messages:f}},{...e,messages:w}})}},y=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return t=>{o.setQueryData(["workflows",{chatId:e}],function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return[t,...e]})}},x=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return(t,s)=>{o.setQueryData(["workflows",{chatId:e}],function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.map(e=>e.id===t?{...e,...s}:e)})}},C=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return(t,s)=>{o.setQueryData(["workflows",{chatId:e}],function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.map(e=>e.id===t?{...e,messages:[...e.messages,s]}:e)})}},I=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",o=(0,w.useQueryClient)();return(t,s)=>{o.setQueryData(["workflows",{chatId:e}],function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];return e.map(e=>{if(e.id===t){let o=e.messages.map(e=>{if(e.id===s.id&&"tool"in e){let o=s.tool.actions?[...e.tool.actions||[],...s.tool.actions]:e.tool.actions;return{...e,content:s.content||e.content,tool:{...e.tool,...s.tool,actions:o}}}return e});return{...e,messages:o}}return e})})}};var S=t(66106),M=t(59920);function b(){let e=new Date,o=Intl.DateTimeFormat().resolvedOptions().timeZone;return{timestamp:e.toISOString(),timezone:o}}let Q=(0,n.createContext)(void 0);function O(e){let{children:o,chatId:t}=e,{getToken:a}=(0,i.aC)(),{store:r}=(0,M.useChatStore)(),d=f(t),w=y(t),O=m(t),T=C(t),W=v(t),D=g(t),N=k(t),E=I(t),J=p(t),P=h(t),L=x(t),F=r(e=>e.setProcessingMessage),{setSidebarChats:_,setHeaderChat:j}=(0,S.useChatLayout)(),q=(0,n.useCallback)((e,o)=>{if("message"===o)try{let o=JSON.parse(e);"user-message"===o.type?F(!1):"chat-name-updated"===o.type?(_(e=>{let s=e.findIndex(e=>e.id===t);if(-1!==s){let t=e.slice();return t[s]={...e[s],name:o.name},t}return e}),j(e=>{var s,n;return{name:o.name,id:null!==(s=null==e?void 0:e.id)&&void 0!==s?s:t,workflow:null!==(n=null==e?void 0:e.workflow)&&void 0!==n?n:[]}}),document.title="".concat(o.name," | Cognosys")):"response"===o.type?u.executeCallback(o.requestId,null,o.data):!function(e){let{socketData:o,reactQuery:t}=e;try{let e=JSON.parse(o);if("new-workflow"==e.type){let{message:o}=e;t.addMessage(o),o.workflow&&t.addWorkflow(o.workflow)}else if("update-workflow"==e.type){let{message:o}=e;t.updateChatWorkflow(o.id,o),"streaming"!==o.status&&t.updateWorkflow(o.id,o)}else if("complete-message"==e.type){let{message:o,workflowId:s,stream:n}=e;s?("tool"==o.role&&t.addToolMessageToChatWorkflow(s,o),t.addMessageToWorkflow(s,o)):"tool"!=o.role||s?t.addMessage(o,n):t.addToolMessage(o)}else if("update-message"===e.type){let{message:o}=e;t.updateMessage(o.id,o)}else if("update-tool"===e.type){let{message:o,workflowId:s}=e;s?(t.updateToolMessageInChatWorkflow(s,o),t.updateToolMessageInWorkflow(s,o)):t.updateToolMessage(o.id,o)}}catch(e){console.error("Failed to parse the message data",e)}}({reactQuery:{addMessage:d,updateMessage:D,addToolMessage:O,updateToolMessage:N,updateToolMessageInChatWorkflow:P,addToolMessageToChatWorkflow:W,updateChatWorkflow:J,addWorkflow:w,addMessageToWorkflow:T,updateToolMessageInWorkflow:E,updateWorkflow:L},socketData:e})}catch(o){console.error("Failed to parse JSON",e)}},[F,d,w,O,T,N,E,P,W,J,D,L,t]),U=(0,n.useCallback)((e,o)=>l.createSocket(e,a,{onOpen:(null==o?void 0:o.onOpen)||(()=>{}),onError:(null==o?void 0:o.onError)||(e=>{console.error("error",e)}),onClose:(null==o?void 0:o.onClose)||(()=>{console.log("Connection closed")}),onMessage:e=>{q(e.data,e.type)}}),[]),X=(0,n.useCallback)(async(e,o,t,s)=>{let n=await a({template:"clerk-email"}),r={...o,auth:{clerkToken:n}},l=U(e);s?function(e,o,t){let s=crypto.randomUUID();o={...o,requestId:s},u.addCallback(s,t),e.send(JSON.stringify(o))}(l,r,s):l.send(JSON.stringify(r))},[U,a]),A=(0,n.useCallback)(async(e,o)=>{d({role:e.message.role,content:e.message.content,documents:e.message.documents,id:(0,c.x0)()});let t={type:"message",from:e.id,to:"backend-api",payload:e,metadata:b()};await X(e.id,t,"message",o)},[d,X]),H=(0,n.useCallback)(async(e,o)=>{let t={type:"action",from:e.chatId,to:"backend-api",payload:e,metadata:b()};await X(e.chatId,t,"action",o)},[X]),Z=(0,n.useMemo)(()=>({getWebSocket:U,sendMessage:A,sendAction:H}),[U,A,H]);return(0,s.jsx)(Q.Provider,{value:Z,children:o})}},37102:function(e,o,t){t.d(o,{X:function(){return n}});var s=t(82933);function n(e,o){let[t,n]=s.useState(o);return s.useEffect(()=>{let o=window.sessionStorage.getItem(e);o&&n(JSON.parse(o))},[e]),[t,function(o){n(o),window.sessionStorage.setItem(e,JSON.stringify(o))}]}}}]);